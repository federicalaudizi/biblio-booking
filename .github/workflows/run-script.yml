name: Daily Python Script

on:
  schedule:
    - cron: '55 4 * * *'  # 7:01 AM Italy time during summer

  workflow_dispatch:     # Allows manual triggering from the GitHub UI

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' 
        
    - name: Wait until 7:01 AM CEST
      run: |
        echo "Waiting until 7:01 AM CEST..."
        while [ "$(TZ=Europe/Rome date +%H:%M)" != "07:01" ]; do
          sleep 5
        done

    - name: Install dependencies
      run: |
        pip install -r requirements.txt  # Only needed if you have this file

    - name: Run script
      run: |
        python biblio_booking.py
    
    - name: Read codice prenotazione
      if: success()
      id: codice
      run: echo "codice=$(cat codice.txt)" >> "$GITHUB_OUTPUT"


    - name: Send Telegram notification
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_CHAT_ID \
          -d text="✅ Daily Python script completed successfully at $(TZ=Europe/Rome date). Codice prenotazione: ${{ steps.codice.outputs.codice }}"

    - name: Send Telegram failure notification
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_CHAT_ID \
          -d text="❌ Daily Python script *failed* at $(TZ=Europe/Rome date)." \
          -d parse_mode=Markdown




